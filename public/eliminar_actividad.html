<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Eliminar actividad</title>
        <link rel="stylesheet" href="estilos.css">
    </head>
    <body>
        <header>
            <h1>Panel administrador - Eliminar actividades</h1>
        </header>
    
    <div class="container">
        <div class="sidebar">
            <br><button onclick="location.href='admin.html'">Volver al menú</button><br>
            <button onclick="location.href='agregar_usuario.html'">Crear nuevo usuario</button><br>
            <button onclick="location.href='crear_actividad.html'">Crear nueva actividad</button><br>
            <button onclick="location.href='Modificar_actividades.html'">Modificar actividades</button><br>
            <button onclick="location.href='eliminar_actividad.html'">Eliminar actividades</button><br>
            <button onclick="location.href='monitorear_actividad.html'">Monitorear progreso</button><br>
            <button onclick="location.href='generar_reporte.html'">Generar reporte de actividades</button><br>
            <button onclick="cerrarSesion()">Cerrar sesión</button>
        </div>
        <div class="main">
            <h3>Lista de actividades disponibles:</h3>
            <div id="listaActividades">
              <p>Cargando actividades...</p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem('token');
      const rol = localStorage.getItem("rol");

      if (!token || rol !== 'Administrador') {
        alert('Acceso denegado. Debes inciar sesión como administrador.');
        window.location.href = 'inicio_sesion.html';
        return;
      }

      try {
        const res = await fetch("https://backend-actividad-fvub.onrender.com/api/activities/todas");
        const actividades = await res.json();
        const contenedor = document.getElementById("listaActividades");
        contenedor.innerHTML = "";

        if (actividades.length === 0) {
          contenedor.innerHTML = "<p>No hay actividades disponibles.</p>";
          return;
        }

        actividades.forEach(act => {
          const div = document.createElement("div");
          div.innerHTML = `
          <h4>${act.nombre}</h4>
            <p><strong>Descripción:</strong> ${act.descripcion}</p>
            <p><strong>Empleado:</strong> ${act.empleado || "Sin asignar"}</p>
            <p><strong>Fecha límite:</strong> ${act.fecha_limite.split('T')[0]}</p>
            <button onclick="eliminarActividad('${act.nombre}')">Eliminar</button>
            <hr>
            `;
            contenedor.appendChild(div);
        });
      } catch (err) {
        console.error("Error al obtener actividades:", err);
        alert("Error al obtener actividades del servidor.");
      }
    });

    async function eliminarActividad(nombre) {
      const confirmar = confirm(`¿Deseas eliminar la actividad "${nombre}"?`);
      if (!confirmar) return;

      try {
        const res = await fetch("https://backend-actividad-fvub.onrender.com/api/activities/eliminar-actividad", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ nombre })
        });

        const data = await res.json();

        if (res.ok) {
          alert("Actividad eliminada correctamente.");
          location.reload();
        } else {
          alert("Error: " + (data.mensaje || "No se pudo eliminar."));
        }
        } catch (err) {
          console.error("Error al eliminar:", err);
          alert("No se pudo conectar con el servidor.");
        }
      }

    function cerrarSesion() {
      localStorage.removeItem("token");
      localStorage.removeItem("rol");
      localStorage.removeItem("nombre");
      window.location.href = "inicio_sesion.html";
    }
  </script>
    </body>
</html>
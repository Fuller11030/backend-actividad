<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Agregar nuevo usuario</title>
        <link rel="stylesheet" href="estilos.css">
    </head>
    <body>
        <header>
            <h1>Panel administrador - Crear nuevo usuario</h1>
        </header>
        <div class="container">
            <div class="sidebar">
                <br><button onclick="location.href='admin.html'">Volver al menú</button><br>
                <button onclick="location.href='agregar_usuario.html'">Crear nuevo usuario</button><br>
                <button onclick="location.href='crear_actividad.html'">Crear nueva actividad</button><br>
                <button onclick="location.href='Modificar_actividades.html'">Modificar actividades</button><br>
                <button onclick="location.href='eliminar_actividad.html'">Eliminar actividad</button><br>
                <button onclick="location.href='monitorear_actividad'">Monitorear progreso</button><br>
                <button onclick="location.href='generar_reporte.html'">Generar reporte de actividades</button><br>
                <button onclick="cerrarSesion()">Cerrar sesión</button>
            </div>
            <div class="main">
                <label for="nombre">Ingrese el nombre:</label>
                <input type="text" id="nombre" class="campo-largo" placeholder="Empiece por apellidos y despues nombre" required>

                <label for="nombre">Teléfono:</label>
                <input type="text" id="telefono" class="campo-largo" placeholder="10 digitos, sin espacios" required>

                <label for="email">Correo electrónico:</label>
                <input type="email" id="email" class="campo-largo" required>

                <label>Dirección:</label>
                <input type="text" id="calle" class="campo-largo" placeholder="Calle" required>
                <input type="text" id="colonia" class="campo-largo" placeholder="Colonia" required>
                <input type="text" id="numero" class="campo-corto" placeholder="Número" required>
                
                <label for="rol">Asigne un rol:</label>
                <select id="rol" class="campo-mediano" required>
                    <option value="">Seleccione un rol</option>
                    <option>Administrador</option>
                    <option>Empleado</option>
                    </select>
                
                <label for="area">Área perteneciente:</label>
                <select id="area" class="campo-mediano" required>
                    <option value="">Seleccione un área</option>
                    <option value="gerencia">Gerencia</option>
                    <option value="rh">Recursos humanos</option>
                    <option value="rf">Recursos financieros</option>
                    <option value="sg">Servicos generales</option>
                    <option value="mantenimiento">Mantenimiento</option>
                    <option value="limpieza">Consergeria</option>
                    <option value="oficina">Oficina</option>
                </select>

                <label for="usuario">Nombre de usuario:</label>
                <input type="text" id="usuario" class="campo-largo" placeholder="Ej: jlopez23 (minúsculas, sin espacios)" required>

                <label for="contrasena">Contraseña:</label>
                <input type="password" id="contrasena" class="campo-largo" placeholder="Al menos 1 mayúscula y 2 números" required>

                <div class="buttons">
                    <button onclick="crearUsuario()">Confirmar creación de usuario</button>
                    <button onclick="location.reload()">Cancelar</button>
                </div>
            </div>
        </div>

        <script>
        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem('token');
        const rol = localStorage.getItem("rol");

        if (!token || rol !== 'Administrador') {
            alert('Acceso denegado. Debes iniciar sesión como administrador.');
            window.location.href = 'inicio_sesion.html';
        }

        const inputs = ["nombre", "telefono", "calle", "colonia", "numero", "email", "rol", "area"];
        inputs.forEach(id => {
            const campo = document.getElementById(id);
            if (campo) {
                campo.addEventListener("input", validarCamposPrevios);
            }
        });

        validarCamposPrevios(); // Para verificar en cuanto cargue la página
    });

    function validarCamposPrevios() {
        const nombre = document.getElementById("nombre")?.value.trim();
        const telefono = document.getElementById("telefono")?.value.trim();
        const calle = document.getElementById("calle")?.value.trim();
        const colonia = document.getElementById("colonia")?.value.trim();
        const numero = document.getElementById("numero")?.value.trim();
        const email = document.getElementById("email")?.value.trim();
        const rol = document.getElementById("rol")?.value.trim();
        const area = document.getElementById("area")?.value.trim();

        const camposLlenos = nombre && telefono && calle && colonia && numero && email && rol && area;

        const usuarioInput = document.getElementById("usuario");
        const contrasenaInput = document.getElementById("contrasena");

        if (camposLlenos) {
            usuarioInput.disabled = false;
            contrasenaInput.disabled = false;
        } else {
            usuarioInput.disabled = true;
            contrasenaInput.disabled = true;
            usuarioInput.value = "";
            contrasenaInput.value = "";
        }
    }

    function cerrarSesion() {
        localStorage.removeItem("token");
        localStorage.removeItem("nombre");
        localStorage.removeItem("rol");
        location.href = "inicio_sesion.html";
    }

    async function crearUsuario() {
        const nombre = document.getElementById("nombre").value.trim();
        const telefono = document.getElementById("telefono").value.trim();
        const calle = document.getElementById("calle").value.trim();
        const colonia = document.getElementById("colonia").value.trim();
        const numero = document.getElementById("numero").value.trim();
        const email = document.getElementById("email").value.trim();
        const rol = document.getElementById("rol").value.trim();
        const area = document.getElementById("area").value.trim();
        const usuario = document.getElementById("usuario").value.trim();
        const contrasena = document.getElementById("contrasena").value.trim();

        const direccion = `${calle}, ${colonia}, ${numero}`;

        if (!/^\d{10}$/.test(telefono)) {
            alert("El teléfono debe tener exactamente 10 números.");
            return;
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            alert("Correo electrónico inválido.");
            return;
        }

        const tieneMayuscula = /[A-Z]/.test(contrasena);
        const tieneDosNumeros = (contrasena.match(/\d/g) || []).length >= 2;

        if (!tieneMayuscula || !tieneDosNumeros) {
            alert("La contraseña debe tener al menos una letra mayúscula y dos números.");
            return;
        }

        try {
            const response = await fetch("https://backend-actividad-fvub.onrender.com/api/users/crear", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    nombre,
                    telefono,
                    email,
                    calle,
                    colonia,
                    numero,
                    rol,
                    area,
                    usuario,
                    contrasena
                })
            });

            const data = await response.json();

            if (response.ok) {
                alert("Usuario creado exitosamente.");
                window.location.href = "admin.html";
            } else {
                alert("Error: " + (data.message || "No se pudo crear el usuario"));
            }
        } catch (error) {
            console.error("Error al crear usuario:", error);
            alert("Error de conexión al servidor.");
        }
    }
    </script>
    </body>
</html>
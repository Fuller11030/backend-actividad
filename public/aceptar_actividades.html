<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Aceptar actividades</title>
        <link rel="stylesheet" href="estilos.css">
    </head>
    <body>
        <header>
            <h1>Acaptar actividades</h1>
        </header>
        <div class="container">
            <div class="sidebar">
                <br><button onclick="location.href='empleado.html'">Voler al menú</button><br>
                <button onclick="location.href='aceptar_actividad.html'">Aceptar actividad</button><br>
                <button onclick="location.href='reportar_progreso.html'">Reportar progreso de actividad</button><br>
                <button onclick="cerrarSesion()">Cerrar sesión</button>
            </div>
            <div class="main" id="listaActividades">
                <p>Cargando actividades...</p>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", async () => {
                const token = localStorage.getItem("token");
                const nombre = localStorage.getItem("nombre");
                const rol = localStorage.getItem("rol");

                if (!token || !nombre || rol !== "Empleado") {
                    alert("No has iniciado sesión como empleado.");
                    return location.href = "inicio_sesion.html";
                }

                try {
                    const response = await fetch("https://backend-actividad-fvub.onrender.com/api/activities/por-empleado", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ nombreEmpleado: nombre })
                    });

                    const actividades = await response.json();
                    const contenedor = document.getElementById("listaActividades");
                    contenedor.innerHTML = "";

                    if (actividades.length === 0) {
                        contenedor.innerHTML = "<p>No tienes actividades asignadas.</p>";
                            return;
                    }

                    actividades.forEach(actividad => {
                        const div = document.createElement("div");
                        div.innerHTML = `
                            <h3>${actividad.nombre}</h3>
                            <p>${actividad.descripcion}</p>
                            <p>Fecha límite: ${actividad.fecha_limite.split('T')[0]}</p>
                            <button onclick="aceptarActividad('${actividad.nombre}', '${nombre}')">Aceptar</button>
                            <hr>
                            `;
                            contenedor.appendChild(div);
                    });
                } catch (err) {
                    console.error(err);
                    alert("Error al cargar actividades.");
                }
            });

            async function aceptarActividad(nombreActividad, nombreEmpleado) {
                const fechaHoy = new Date().toISOString().split("T")[0];

                try {
                    const response = await fetch("https://backend-actividad-fvub.onrender.com/api/activities/aceptar", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            nombreActividad,
                            nombreEmpleado,
                            fecha: fechaHoy 
                        })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        alert("Actividad aceptada.");
                        location.reload();
                    } else {
                        alert("Error: " + data.mensaje);
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error al aceptar actividad.");
                }
            }

            function cerrarSesion() {
                localStorage.removeItem("token");
                localStorage.removeItem("nombre");
                localStorage.removeItem("rol");
                location.href = "inicio_sesion.html";
            }
        </script>
    </body>
</html>